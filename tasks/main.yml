---
- name: Check if git binary exists
  stat:
    path: /usr/bin/git
  register: GIT_EXISTS
- name: Install git dependencies
  package:
    name: [git]
    state: present
  become: yes
  vars:
    ansible_python_interpreter: "{{ SYSTEM_PYTHON }}"
  when: not GIT_EXISTS.stat.exists
- name: Check if javac binary exists
  stat:
    path: /usr/bin/javac
  register: JAVAC_EXISTS
- name: Install java dependencies
  package:
    name: [git,java-1.8.0-openjdk]
    state: present
  become: yes
  vars:
    ansible_python_interpreter: "{{ SYSTEM_PYTHON }}"
  when: not JAVAC_EXISTS.stat.exists
- name: "install python pip dependencies"
  pip:
    name: psycopg2-binary
    state: present
  vars:
    ansible_python_interpreter: "{{ PROJECT_PYTHON }}"

###############
# Project dir #
###############

- name: Check for the {{ PROJECT_NAME }} .git directory
  stat:
    path: "{{ PROJECT_SRC }}/.git"
  register: PROJECT_GIT_DIR
- name: Check for the {{ PROJECT_NAME }} README.md file
  stat:
    path: "{{ PROJECT_SRC }}/README.md"
  register: PROJECT_README
- name: Create the {{ PROJECT_NAME }} source directory {{ PROJECT_SRC }}
  file:
    name: "{{ PROJECT_SRC }}"
    state: directory
    owner: "{{ USER_NAME }}"
  become: yes
  when: not PROJECT_GIT_DIR.stat.exists and not PROJECT_README.stat.exists
- name: Clone the {{ PROJECT_REPO }} source code into {{ PROJECT_SRC }}
  git:
    repo: "{{ PROJECT_REPO }}"
    dest: "{{ PROJECT_SRC }}"
  when: not PROJECT_GIT_DIR.stat.exists and not PROJECT_README.stat.exists

##############
# Static dir #
##############

- name: Check for the {{ PROJECT_STATIC_NAME }} .git directory
  stat:
    path: "{{ PROJECT_SRC }}-static/.git"
  register: PROJECT_STATIC_GIT_DIR
- name: Create the {{ PROJECT_STATIC_NAME }} source directory {{ PROJECT_SRC }}-static
  file:
    name: "{{ PROJECT_SRC }}-static"
    state: directory
    owner: "{{ USER_NAME }}"
  become: yes
  when: not PROJECT_STATIC_GIT_DIR.stat.exists
- name: Clone the {{ PROJECT_STATIC_REPO }} source code into {{ PROJECT_SRC }}-static
  git:
    repo: "{{ PROJECT_STATIC_REPO }}"
    dest: "{{ PROJECT_SRC }}-static"
  when: not PROJECT_STATIC_GIT_DIR.stat.exists

###############
# Ansible dir #
###############

- name: Check for the {{ PROJECT_ANSIBLE_NAME }} .git directory
  stat:
    path: "{{ PROJECT_SRC }}-ansible/.git"
  register: PROJECT_ANSIBLE_GIT_DIR
- name: Create the {{ PROJECT_ANSIBLE_NAME }} source directory {{ PROJECT_SRC }}-ansible
  file:
    name: "{{ PROJECT_SRC }}-ansible"
    state: directory
    owner: "{{ USER_NAME }}"
  become: yes
  when: not PROJECT_ANSIBLE_GIT_DIR.stat.exists
- name: Clone the {{ PROJECT_ANSIBLE_REPO }} source code into {{ PROJECT_SRC }}-ansible
  git:
    repo: "{{ PROJECT_ANSIBLE_REPO }}"
    dest: "{{ PROJECT_SRC }}-ansible"
  when: not PROJECT_ANSIBLE_GIT_DIR.stat.exists

###########
# Service #
###########

- name: Create the {{ PROJECT_NAME }} systemd services. 
  template:
    src: project_service
    dest: "/usr/lib/systemd/system/watch-{{ item.PROJECT_NAME }}.service"
  become: yes
  loop: "{{ PROJECT_SERVICES }}"
  when: ENABLE_CODE_GENERATION_SERVICE and ansible_pkg_mgr != 'homebrew'
- name: Create the {{ item.PROJECT_NAME }} config dirs. 
  file:
    name: "{{ item.PROJECT_SRC }}/config"
    state: directory
    owner: "{{ USER_NAME }}"
  loop: "{{ PROJECT_SERVICES }}"
- name: Create the {{ item.PROJECT_NAME }} enUS configs. 
  template:
    src: "{{ item.PROJECT_SRC }}/config/template.yml"
    dest: "{{ item.PROJECT_SRC }}/config/{{ item.PROJECT_NAME }}.yml"
  loop: "{{ PROJECT_SERVICES }}"
- name: Reload the services. 
  systemd:
    daemon_reload: yes
  become: yes
  loop: "{{ PROJECT_SERVICES }}"
  when: ENABLE_CODE_GENERATION_SERVICE and ansible_pkg_mgr != 'homebrew'
- name: Start and enable the {{ item.PROJECT_NAME }} services. 
  service:
    name: "watch-{{ item.PROJECT_NAME }}"
    enabled: yes
    state: restarted
  become: yes
  loop: "{{ PROJECT_SERVICES }}"
  when: ENABLE_CODE_GENERATION_SERVICE and ansible_pkg_mgr != 'homebrew'
- name: Create the {{ PROJECT_NAME }} launchd service {{ PROJECT_SYSTEMD }}.
  template:
    src: project_launchd_service
    dest: "~/Library/LaunchAgents/org.project.plist"
  loop: "{{ PROJECT_SERVICES }}"
  when: ENABLE_CODE_GENERATION_SERVICE and ansible_pkg_mgr == 'homebrew'
- name: Load the {{ PROJECT_NAME }} launchd service {{ PROJECT_SYSTEMD }}.
  shell: launchctl load ~/Library/LaunchAgents/org.project.plist
  when: ENABLE_CODE_GENERATION_SERVICE and ansible_pkg_mgr == 'homebrew'
- name: Start the {{ PROJECT_NAME }} launchd service {{ PROJECT_SYSTEMD }}.
  shell: launchctl start org.project
  when: ENABLE_CODE_GENERATION_SERVICE and ansible_pkg_mgr == 'homebrew'
  changed_when: false


##############
# PostgreSQL #
##############

- name: Create enUS database user
  postgresql_user:
    name: "{{ JDBC_USERNAME }}"
    password: "{{ JDBC_PASSWORD }}"
    login_unix_socket: /tmp
    login_user: "{{ POSTGRES_BECOME_USER }}"
    db: postgres
  become: true
  become_user: "{{ POSTGRES_BECOME_USER }}"
- name: Create enUS database
  postgresql_db:
    name: "{{ JDBC_DATABASE }}"
    owner: "{{ JDBC_USERNAME }}"
    login_unix_socket: /tmp
    login_user: "{{ POSTGRES_BECOME_USER }}"
    db: postgres
  become: true
  become_user: "{{ POSTGRES_BECOME_USER }}"
- name: Grant user access to database
  postgresql_pg_hba:
    dest: "{{ POSTGRES_HBA_CONF }}"
    contype: host
    users: "{{ JDBC_USERNAME }}"
    source: "all"
    databases: "{{ JDBC_DATABASE }}"
    method: md5
    create: true
  become: true
  become_user: "{{POSTGRES_BECOME_USER}}"
- name: Restart the postgresql service. 
  service:
    name: "{{ POSTGRES_SERVICE }}"
    state: restarted
  become: yes
  when: ansible_pkg_mgr != 'homebrew'
- name: Start the {{ POSTGRES_NAME }} launchd service.
  shell: launchctl start org.postgresql
  when: ansible_pkg_mgr == 'homebrew'
  changed_when: false

###############
# Solr Search #
###############

- name: Check for existing solr collection enUS
  shell: "{{ SOLR_OPT }}/server/scripts/cloud-scripts/zkcli.sh -zkhost localhost:{{ ZOOKEEPER_PORT }} -cmd ls /collections/{{ SOLR_COLLECTION }}"
  ignore_errors: yes
  register: SOLR_COLLECTION_EXISTS
  changed_when: false
- name: Create collection in solr enUS
  shell: "{{ SOLR_OPT }}/bin/solr create -n computate -c {{ SOLR_COLLECTION }}"
  when: SOLR_COLLECTION_EXISTS.rc != 0

###########
# SSL/TLS #
###########

- name: Create the keystore directory {{ SSL_KEYSTORE_PATH }}
  file:
    name: "{{ SSL_KEYSTORE_PATH }}"
    state: directory
    owner: "{{ USER_NAME }}"
  become: yes
  when: SITE_BASE_URL is regex("^https://")
- name: Create the {{ PROJECT_NAME }} keystore properties {{ SSL_KEYSTORE_PATH }}/{{ SSL_PROPERTIES_FILENAME }}
  template:
    src: project_keystore.properties
    dest: "{{ SSL_KEYSTORE_PATH }}/{{ SSL_PROPERTIES_FILENAME }}"
  when: SITE_BASE_URL is regex("^https://")
- name: Create the {{ PROJECT_NAME }} keystore jks {{ SSL_JKS_PATH }}
  shell: echo {{ SSL_JKS_BASE64 }} | base64 -d > {{ SSL_JKS_PATH }}
  when: SITE_BASE_URL is regex("^https://")
- name: Build the source code in /usr/local/src/computate
  shell: "mvn clean install"
  args:
    chdir: "/usr/local/src/computate"
- name: Build the source code in {{ PROJECT_SRC }}
  shell: "mvn clean install"
  args:
    chdir: "{{ PROJECT_SRC }}"
